<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cyberpunk Integral Bee - Math Puzzle Challenge</title>
  <!-- Neon Cyberpunk Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <!-- Cyberpunk-inspired CSS -->
  <style>
    :root {
      --cyber-bg: #0f172a;
      --cyber-card: rgba(24, 29, 52, 0.98);
      --neon-green: #39ff14;
      --neon-pink: #ff00cc;
      --neon-blue: #00eaff;
      --neon-yellow: #ffe700;
      --neon-orange: #ff5800;
      --glow: 0 0 12px var(--neon-green), 0 0 40px var(--neon-blue);
      --glow-pink: 0 0 16px var(--neon-pink), 0 0 40px var(--neon-pink);
      --glow-blue: 0 0 16px var(--neon-blue), 0 0 40px var(--neon-blue);
      --glow-orange: 0 0 16px var(--neon-orange), 0 0 40px var(--neon-orange);
      --shadow: 0 0 40px #0ff9 0 0 80px #00eaff33;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: radial-gradient(ellipse at top right, #010220 60%, #0f172a 100%);
      font-family: 'Share Tech Mono', 'Orbitron', monospace, Arial, sans-serif;
      color: var(--neon-blue);
      min-height: 100vh;
      overflow-x: hidden;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
      background: linear-gradient(135deg, #0f172a 0%, #20224a 70%, #1a1832 100%);
      position: relative;
    }
    /* Animated cyberpunk grid background */
    .cyber-bg-anim {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
      background: transparent;
      overflow: hidden;
    }
    .cyber-bg-anim svg {
      width: 100vw; height: 100vh;
    }
    /* Main app card */
    .main-card {
      z-index: 1;
      background: var(--cyber-card);
      border-radius: 24px;
      box-shadow:
        0 0 80px #00eaff33,
        0 0 12px #ff00cc33,
        0 0 2px #39ff1444;
      padding: 2.2em 1.4em 2.8em 1.4em;
      margin: 2vw;
      width: 100%;
      max-width: 540px;
      min-width: 310px;
      position: relative;
      border: 2.5px solid var(--neon-blue);
      border-top: 2.5px solid var(--neon-pink);
      border-bottom: 2.5px solid var(--neon-green);
      box-sizing: border-box;
      animation: pulse-card 3s infinite alternate;
    }
    @keyframes pulse-card {
      0% { box-shadow: 0 0 40px #00eaff33, 0 0 6px #ff00cc22, 0 0 1.2px #39ff1444;}
      100% { box-shadow: 0 0 120px #00eaff88, 0 0 16px #ff00cc66, 0 0 3px #39ff14bb;}
    }
    /* Title */
    .title {
      font-family: 'Orbitron', 'Share Tech Mono', monospace;
      font-size: 2.2em;
      letter-spacing: 0.12em;
      text-align: center;
      color: var(--neon-pink);
      text-shadow: var(--glow-pink);
      margin-bottom: 0.8em;
      margin-top: 0.2em;
      animation: flicker 3s infinite alternate;
    }
    @keyframes flicker {
      0%, 100% { opacity: 1; filter: brightness(1);}
      80% { opacity: 0.93; filter: brightness(1.13);}
      90% { opacity: 0.88; filter: brightness(1.17);}
      95% { opacity: 1; filter: brightness(1.25);}
    }
    /* Score and info bar */
    .info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.1em;
      gap: 1.1em;
      color: var(--neon-blue);
      font-size: 1.08em;
      font-family: 'Share Tech Mono', monospace;
      text-shadow: 0 0 8px var(--neon-blue);
      user-select: none;
    }
    .info-bar .score { color: var(--neon-green); text-shadow: var(--glow);}
    .info-bar .timer { color: var(--neon-pink); text-shadow: var(--glow-pink);}
    .info-bar .level { color: var(--neon-yellow); text-shadow: 0 0 8px var(--neon-yellow);}
    .info-bar .streak { color: var(--neon-orange); text-shadow: var(--glow-orange);}
    /* Puzzle box */
    .puzzle-box {
      background: rgba(18, 30, 50, 0.92);
      border: 2.5px solid var(--neon-pink);
      border-radius: 12px;
      box-shadow: 0 0 26px #ff00cc44, 0 0 3px var(--neon-blue);
      padding: 1.4em 1em 1.2em 1em;
      margin-bottom: 1.3em;
      color: var(--neon-blue);
      min-height: 88px;
      font-size: 1.21em;
      font-family: 'Share Tech Mono', monospace;
      text-shadow: 0 0 10px var(--neon-blue);
      position: relative;
      transition: box-shadow 0.4s, border 0.4s;
      overflow-x: auto;
    }
    .puzzle-box.lit {
      border: 2.5px solid var(--neon-green);
      box-shadow: 0 0 32px var(--neon-green), 0 0 8px #39ff1444;
      color: var(--neon-green);
      text-shadow: 0 0 18px var(--neon-green);
    }
    .puzzle-box svg {
      vertical-align: middle;
    }
    /* MathJax fallback style */
    .math {
      font-family: 'Share Tech Mono', monospace;
      font-size: 1.1em;
      color: var(--neon-yellow);
    }
    /* Input area */
    .answer-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.7em;
    }
    .answer-input {
      padding: 0.82em 1.4em;
      font-size: 1.14em;
      border-radius: 9px;
      border: none;
      background: #181c39;
      color: var(--neon-blue);
      box-shadow: 0 0 10px var(--neon-blue);
      outline: none;
      margin-bottom: 0.4em;
      width: 78%;
      max-width: 340px;
      text-align: center;
      transition: box-shadow 0.3s, background 0.3s;
      font-family: 'Share Tech Mono', monospace;
    }
    .answer-input:focus {
      background: #222971;
      box-shadow: 0 0 18px var(--neon-green);
      color: var(--neon-green);
    }
    .answer-btns {
      display: flex;
      gap: 1em;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn {
      font-family: 'Orbitron', 'Share Tech Mono', monospace;
      font-weight: 700;
      font-size: 1.03em;
      border: none;
      border-radius: 8px;
      padding: 0.68em 2.2em;
      cursor: pointer;
      background: linear-gradient(90deg, var(--neon-blue) 0%, var(--neon-pink) 100%);
      color: #111;
      box-shadow: 0 0 16px var(--neon-pink);
      margin: 0.2em 0;
      transition: background 0.3s, box-shadow 0.3s, color 0.3s, transform 0.1s;
      letter-spacing: 0.06em;
      text-shadow: none;
    }
    .btn:active {
      transform: scale(0.97);
      box-shadow: 0 0 10px var(--neon-green);
      color: var(--neon-green);
    }
    .btn-correct {
      background: linear-gradient(90deg, var(--neon-green) 0%, var(--neon-yellow) 100%);
      color: #181818;
      box-shadow: 0 0 24px var(--neon-green);
      border-color: var(--neon-green);
    }
    .btn-wrong {
      background: linear-gradient(90deg, var(--neon-pink) 0%, var(--neon-orange) 100%);
      color: #eee;
      box-shadow: 0 0 16px var(--neon-pink);
      border-color: var(--neon-orange);
    }
    /* Result styles */
    .result-message {
      margin-top: 0.7em;
      font-size: 1.18em;
      font-family: 'Orbitron', 'Share Tech Mono', monospace;
      min-height: 2em;
      color: var(--neon-pink);
      text-shadow: 0 0 12px var(--neon-pink);
      font-weight: 700;
      transition: color 0.3s;
      animation: none;
    }
    .result-message.correct {
      color: var(--neon-green);
      text-shadow: 0 0 32px var(--neon-green);
      animation: pop 0.75s;
    }
    .result-message.wrong {
      color: var(--neon-orange);
      text-shadow: 0 0 24px var(--neon-orange);
      animation: shake 0.45s;
    }
    @keyframes pop {
      0% { transform: scale(1);}
      60% { transform: scale(1.19);}
      100% { transform: scale(1);}
    }
    @keyframes shake {
      0% { transform: translateX(0);}
      20% { transform: translateX(-9px);}
      40% { transform: translateX(9px);}
      60% { transform: translateX(-9px);}
      80% { transform: translateX(9px);}
      100% { transform: translateX(0);}
    }
    /* Progress bar */
    .progress-bar {
      position: relative;
      width: 100%;
      height: 12px;
      background: #181c39;
      border-radius: 7px;
      overflow: hidden;
      margin: 1.1em 0 1.8em 0;
      box-shadow: 0 0 10px var(--neon-blue);
      border: 1.5px solid var(--neon-green);
    }
    .progress-inner {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--neon-pink) 10%, var(--neon-blue) 90%);
      box-shadow: 0 0 18px var(--neon-pink), 0 0 30px var(--neon-blue);
      border-radius: 7px;
      transition: width 0.5s;
    }
    /* Achievements */
    .achievements {
      margin-top: 0.6em;
      color: var(--neon-yellow);
      font-size: 1em;
      display: flex;
      gap: 1.2em;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      min-height: 2.1em;
    }
    .achievement-badge {
      background: linear-gradient(90deg, #ffe700 0%, #ff00cc 100%);
      color: #0f172a;
      border-radius: 12px;
      padding: 0.2em 0.75em;
      font-size: 0.92em;
      font-weight: 700;
      box-shadow: 0 0 10px #ffe700bb;
      margin: 0.2em 0.1em;
      text-shadow: none;
      border: 2px solid #ff00cc;
      transition: background 0.3s, color 0.3s;
      user-select: none;
    }
    /* Settings Panel */
    .settings-btn {
      position: absolute;
      top: 1.1em;
      right: 1.1em;
      background: none;
      border: none;
      color: var(--neon-blue);
      font-size: 1.6em;
      cursor: pointer;
      filter: drop-shadow(0 0 7px var(--neon-blue));
      z-index: 2;
      transition: color 0.2s, filter 0.2s;
    }
    .settings-btn:hover {
      color: var(--neon-green);
      filter: drop-shadow(0 0 16px var(--neon-green));
    }
    .settings-panel {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(10, 14, 24, 0.91);
      z-index: 99;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
    }
    .settings-panel.open {
      opacity: 1;
      pointer-events: auto;
    }
    .settings-content {
      background: #14182f;
      border: 2px solid var(--neon-blue);
      border-top: 2.5px solid var(--neon-pink);
      border-radius: 18px;
      box-shadow: 0 0 50px #00eaff66, 0 0 10px #ff00cc88;
      padding: 2em 1.2em 1.4em 1.2em;
      min-width: 290px;
      max-width: 95vw;
      color: var(--neon-blue);
      text-align: left;
      font-size: 1.08em;
      position: relative;
    }
    .settings-content h2 {
      font-family: 'Orbitron', 'Share Tech Mono', monospace;
      color: var(--neon-pink);
      text-shadow: var(--glow-pink);
      margin-bottom: 0.6em;
      font-size: 1.25em;
    }
    .settings-close {
      position: absolute;
      top: 0.7em; right: 1em;
      background: none;
      border: none;
      color: var(--neon-yellow);
      font-size: 1.5em;
      cursor: pointer;
      filter: drop-shadow(0 0 7px var(--neon-yellow));
    }
    .settings-option {
      margin: 0.7em 0;
      display: flex;
      align-items: center;
      gap: 1em;
    }
    .setting-switch {
      width: 40px; height: 22px;
      background: #282c50;
      border: 2px solid var(--neon-blue);
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
      display: inline-block;
    }
    .setting-switch[data-state="on"] {
      background: var(--neon-blue);
      border-color: var(--neon-green);
    }
    .setting-knob {
      width: 20px; height: 20px;
      border-radius: 100%;
      background: var(--neon-pink);
      position: absolute;
      top: 1px; left: 1px;
      transition: left 0.3s, background 0.3s;
      box-shadow: 0 0 8px var(--neon-pink);
    }
    .setting-switch[data-state="on"] .setting-knob {
      left: 19px;
      background: var(--neon-green);
      box-shadow: 0 0 16px var(--neon-green);
    }
    .settings-option label {
      font-size: 1em;
      color: var(--neon-yellow);
      font-family: 'Share Tech Mono', monospace;
    }
    /* Timer pulse warning */
    .timer.warning {
      animation: timer-pulse 0.7s infinite alternate;
      color: var(--neon-orange) !important;
      text-shadow: 0 0 18px var(--neon-orange);
    }
    @keyframes timer-pulse {
      0% { filter: brightness(1);}
      100% { filter: brightness(2);}
    }
    /* Responsive */
    @media (max-width: 600px) {
      .main-card { padding: 1.05em 0.1em 2.5em 0.1em;}
      .title { font-size: 1.17em;}
      .info-bar { font-size: 0.92em;}
      .puzzle-box { font-size: 0.93em; padding: 0.7em 0.3em;}
      .answer-input { width: 96%; font-size: 1em;}
      .btn { width: 98%; font-size: 0.96em;}
      .settings-content { min-width: 98vw;}
    }
  </style>
</head>
<body>
<div class="cyber-bg-anim" aria-hidden="true">
  <svg>
    <!-- Neon grid lines -->
    <g id="grid-lines"></g>
    <!-- Neon floating shapes -->
    <g id="floating-neon"></g>
  </svg>
</div>
<div class="main-card">
  <button class="settings-btn" id="settingsOpenBtn" aria-label="Open settings">&#9881;</button>
  <div class="title">CYBERBEE: Integral & Math Puzzle Arena</div>
  <div class="info-bar">
    <span class="score" id="scoreBox">Score: 0</span>
    <span class="level" id="levelBox">Level 1</span>
    <span class="timer" id="timerBox">00:00</span>
    <span class="streak" id="streakBox">Streak: 0</span>
  </div>
  <div class="progress-bar">
    <div class="progress-inner" id="progressInner"></div>
  </div>
  <div class="puzzle-box" id="puzzleBox">
    Loading puzzle...
  </div>
  <form class="answer-area" id="answerForm" autocomplete="off">
    <input type="text" id="answerInput" class="answer-input" placeholder="Type answer here" autocomplete="off" spellcheck="false" autocapitalize="off" />
    <div class="answer-btns">
      <button type="submit" class="btn" id="submitBtn">Submit</button>
      <button type="button" class="btn" id="skipBtn">Skip</button>
      <button type="button" class="btn" id="hintBtn">Hint</button>
    </div>
  </form>
  <div class="result-message" id="resultBox"></div>
  <div class="achievements" id="achievementsBox"></div>
</div>
<!-- Settings Panel -->
<div class="settings-panel" id="settingsPanel">
  <div class="settings-content">
    <button class="settings-close" id="settingsCloseBtn" aria-label="Close settings">&times;</button>
    <h2>Settings</h2>
    <div class="settings-option">
      <label for="toggleSound">Sound</label>
      <div class="setting-switch" id="toggleSoundSwitch" data-state="on">
        <div class="setting-knob"></div>
      </div>
    </div>
    <div class="settings-option">
      <label for="toggleTheme">Theme</label>
      <div class="setting-switch" id="toggleThemeSwitch" data-state="cyberpunk">
        <div class="setting-knob"></div>
      </div>
      <span id="themeLabel" style="color:var(--neon-yellow);font-size:0.94em;">Cyberpunk</span>
    </div>
    <div class="settings-option">
      <label for="difficultySelect">Difficulty</label>
      <select id="difficultySelect" style="font-size:1em;padding:0.2em 0.5em;border-radius:7px;background:#1f232f;color:var(--neon-blue);border:1.5px solid var(--neon-blue);">
        <option value="easy">Easy</option>
        <option value="normal">Normal</option>
        <option value="hard" selected>Hard</option>
        <option value="bee">Integral Bee</option>
      </select>
    </div>
    <div class="settings-option">
      <label for="typingModeSwitch">Keyboard Mode</label>
      <div class="setting-switch" id="typingModeSwitch" data-state="on">
        <div class="setting-knob"></div>
      </div>
      <span style="color:var(--neon-yellow);font-size:0.94em;">Math Shortcuts</span>
    </div>
    <div class="settings-option">
      <button class="btn" style="background:linear-gradient(90deg,#ff00cc 0%,#21eaff 100%);color:#0f172a;font-size:1em;" id="resetGameBtn">Reset Progress</button>
    </div>
  </div>
</div>
<!-- MathJax for LaTeX rendering -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- Sound FX -->
<audio id="sfx-correct" src="https://cdn.jsdelivr.net/gh/aleen42/static/sounds/correct.mp3"></audio>
<audio id="sfx-wrong" src="https://cdn.jsdelivr.net/gh/aleen42/static/sounds/error.mp3"></audio>
<audio id="sfx-hint" src="https://cdn.jsdelivr.net/gh/aleen42/static/sounds/hint.mp3"></audio>
<audio id="sfx-next" src="https://cdn.jsdelivr.net/gh/aleen42/static/sounds/next.mp3"></audio>
<script>
/* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
   ||      CYBERBEE: INTEGRAL BEE & MATH PUZZLE GAME ENGINE         ||
   ||      (c) 2025 - Alexia Tsoukala, Cyberpunk UI, Math Logic     ||
   -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
   ||      Code modularized & commented for maintainability         ||
   -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
*/
/* ========== GLOBAL SETTINGS AND STATE ========== */
const GAME = {
  level: 1,
  score: 0,
  streak: 0,
  maxLevel: 25,
  timer: 0,
  timerStart: 0,
  timerInterval: null,
  puzzle: null,
  puzzleIndex: 0,
  totalPuzzles: 0,
  difficulty: "hard",
  streakMax: 0,
  achievements: new Set(),
  sound: true,
  theme: "cyberpunk",
  typingMode: true, // allows LaTeX/math input shortcuts
  puzzleHistory: [],
  beeMode: false,
  easyStreak: 0,
  beeCorrect: 0,
  beeTotal: 0,
  skipCount: 0,
  hintUsed: 0,
  beeActive: false
};
const UI = {
  scoreBox: document.getElementById("scoreBox"),
  levelBox: document.getElementById("levelBox"),
  timerBox: document.getElementById("timerBox"),
  streakBox: document.getElementById("streakBox"),
  progressInner: document.getElementById("progressInner"),
  puzzleBox: document.getElementById("puzzleBox"),
  answerInput: document.getElementById("answerInput"),
  answerForm: document.getElementById("answerForm"),
  submitBtn: document.getElementById("submitBtn"),
  skipBtn: document.getElementById("skipBtn"),
  hintBtn: document.getElementById("hintBtn"),
  resultBox: document.getElementById("resultBox"),
  achievementsBox: document.getElementById("achievementsBox"),
  settingsOpenBtn: document.getElementById("settingsOpenBtn"),
  settingsPanel: document.getElementById("settingsPanel"),
  settingsCloseBtn: document.getElementById("settingsCloseBtn"),
  toggleSoundSwitch: document.getElementById("toggleSoundSwitch"),
  toggleThemeSwitch: document.getElementById("toggleThemeSwitch"),
  difficultySelect: document.getElementById("difficultySelect"),
  typingModeSwitch: document.getElementById("typingModeSwitch"),
  resetGameBtn: document.getElementById("resetGameBtn"),
  themeLabel: document.getElementById("themeLabel")
};
/* ========== PUZZLE GENERATORS ========== */
/**
 * Puzzle object format:
 * {
 *   question: "string (may include LaTeX)",
 *   answer: "string" or number or function (answer checker),
 *   latex: true/false,
 *   hint: "string",
 *   type: "algebra"|"sequence"|"integral"|"bee"|"logic"|"number-theory"|"geometry"
 * }
 */
const PUZZLES = {
  easy: [],
  normal: [],
  hard: [],
  bee: []
};
const PUZZLE_GENERATORS = {
  easy: [
    genArithmeticPuzzle, genSequenceEasy, genAlgebraEasy
  ],
  normal: [
    genAlgebraNormal, genSequenceNormal, genNumberTheoryNormal, genLogicNormal
  ],
  hard: [
    genAlgebraHard, genSequenceHard, genNumberTheoryHard, genLogicHard, genGeometryHard
  ],
  bee: [
    genIntegrationBeePuzzle, genSeriesBeePuzzle, genLimitBeePuzzle
  ]
};
const BEE_PUZZLES = [
  // Hand-chosen MIT Integration Bee–level puzzles
  {
    question: "\\(\\int_0^{\\infty} e^{-x^2} dx\\)",
    answer: (a) => Math.abs(parseFloat(a) - Math.sqrt(Math.PI)/2) < 0.02,
    latex: true,
    hint: "This is the Gaussian integral.",
    type: "bee"
  },
  {
    question: "\\(\\int_0^1 \\frac{\\ln(1+x)}{x} dx\\)",
    answer: (a) => Math.abs(parseFloat(a) - Math.PI* Math.PI /12) < 0.02,
    latex: true,
    hint: "It's a famous log integral, relates to the Basel problem.",
    type: "bee"
  },
  {
    question: "\\(\\int_{-\\infty}^{\\infty} \\frac{1}{x^2 + 1} dx\\)",
    answer: (a) => Math.abs(parseFloat(a) - Math.PI) < 0.02,
    latex: true,
    hint: "Use arctan(x).",
    type: "bee"
  },
  {
    question: "\\(\\int_0^{\\pi} \\sin^3 x\\, dx\\)",
    answer: (a) => Math.abs(parseFloat(a) - (4/3)) < 0.02,
    latex: true,
    hint: "Use the reduction formula or rewrite using \\(\\sin^3 x = (3\\sin x - \\sin 3x)/4\\).",
    type: "bee"
  },
  {
    question: "\\(\\int_{0}^{1} \\frac{1}{1+x^2}\\, dx\\)",
    answer: (a) => Math.abs(parseFloat(a) - Math.atan(1)) < 0.02,
    latex: true,
    hint: "It's arctan(1) - arctan(0).",
    type: "bee"
  },
  {
    question: "\\(\\int_0^{\\pi/2} \\ln \\sin x\\, dx\\)",
    answer: (a) => Math.abs(parseFloat(a) + (Math.PI*Math.log(2))/2) < 0.02,
    latex: true,
    hint: "Famous integral, negative, involves \\(\\ln 2\\).",
    type: "bee"
  },
  {
    question: "\\(\\lim_{x \\to 0} \\frac{\\sin x - x}{x^3}\\)",
    answer: (a) => Math.abs(parseFloat(a) + 1/6) < 0.02,
    latex: true,
    hint: "Use Taylor expansion of \\(\\sin x\\).",
    type: "bee"
  },
  {
    question: "\\(\\int_0^1 x^{x} dx\\) (to 2 decimals)",
    answer: (a) => Math.abs(parseFloat(a) - 0.783) < 0.02,
    latex: true,
    hint: "There is no elementary form, but it's \\(\\approx 0.783\\).",
    type: "bee"
  },
  {
    question: "\\(\\sum_{n=1}^{\\infty} \\frac{1}{n^2}\\)",
    answer: (a) => Math.abs(parseFloat(a) - Math.PI*Math.PI/6) < 0.02,
    latex: true,
    hint: "Basel Problem.",
    type: "bee"
  },
  {
    question: "\\(\\int_0^{\\infty} \\frac{1}{1+x^2}\\, dx\\)",
    answer: (a) => Math.abs(parseFloat(a) - (Math.PI/2)) < 0.02,
    latex: true,
    hint: "Arctan(∞) = π/2.",
    type: "bee"
  }
];
/* ========== PUZZLE GENERATOR IMPLEMENTATIONS ========== */
/*--- Easy ---*/
function genArithmeticPuzzle() {
  // Add, subtract, multiply, divide, modulo
  let op = ["+", "-", "×", "÷", "%"][randInt(0,4)];
  let a = randInt(7, 99), b = randInt(5, 33);
  let q = "", ans = 0;
  switch (op) {
    case "+": q = `\\(${a} + ${b}\\)`; ans = a+b; break;
    case "-": q = `\\(${a} - ${b}\\)`; ans = a-b; break;
    case "×": q = `\\(${a} \\times ${b}\\)`; ans = a*b; break;
    case "÷": q = `\\(${a*b} \\div ${b}\\)`; ans = a; break;
    case "%": q = `\\(${a} \\bmod ${b}\\)`; ans = a%b; break;
  }
  return {
    question: q,
    answer: ans,
    latex: true,
    hint: "Apply the operation.",
    type: "arithmetic"
  };
}
function genSequenceEasy() {
  // Simple arithmetic progression
  let start = randInt(2,10), diff = randInt(2,8), len = 5;
  let seq = [];
  for(let i=0;i<len;i++) seq.push(start + i*diff);
  return {
    question: `What is the next number? ${seq.join(", ")}, ?`,
    answer: start + len*diff,
    latex: false,
    hint: "It's an arithmetic progression.",
    type: "sequence"
  };
}
function genAlgebraEasy() {
  let x = randInt(2,9), b = randInt(1,6), c = x + b;
  return {
    question: `Solve: \\(x + ${b} = ${c}\\)`,
    answer: x,
    latex: true,
    hint: "Isolate x.",
    type: "algebra"
  };
}
/*--- Normal ---*/
function genAlgebraNormal() {
  let a = randInt(2,7), x = randInt(2,9), b = randInt(3,11), c = a*x + b;
  return {
    question: `Solve: \\(${a}x + ${b} = ${c}\\)`,
    answer: x,
    latex: true,
    hint: "Isolate x.",
    type: "algebra"
  };
}
function genSequenceNormal() {
  // Geometric or Fibonacci
  if (randInt(0,1) === 0) {
    // Geometric
    let start = randInt(1,3), ratio = randInt(2,5), len=5;
    let seq = [];
    for(let i=0;i<len;i++) seq.push(start * Math.pow(ratio,i));
    return {
      question: `Next number? ${seq.join(", ")}, ?`,
      answer: start * Math.pow(ratio, len),
      latex: false,
      hint: "It's a geometric sequence.",
      type: "sequence"
    };
  } else {
    // Fibonacci
    let fib = [1,1], n=5;
    for(let i=2;i<n;i++) fib.push(fib[i-1]+fib[i-2]);
    return {
      question: `Next number? ${fib.join(", ")}, ?`,
      answer: fib[n-1]+fib[n-2],
      latex: false,
      hint: "It's the Fibonacci sequence.",
      type: "sequence"
    };
  }
}
function genNumberTheoryNormal() {
  // Find GCD
  let a = randInt(20,99), b = randInt(10,29);
  let ans = gcd(a,b);
  return {
    question: `GCD of ${a} and ${b}`,
    answer: ans,
    latex: false,
    hint: "Use the Euclidean algorithm.",
    type: "number-theory"
  };
}
function genLogicNormal() {
  // Simple logic: "If all bloops are bloops and bloops are blops, are all bloops blops?" Yes.
  let things = [["cats","mammals"],["roses","flowers"],["squares","rectangles"],["penguins","birds"]];
  let i = randInt(0,things.length-1);
  let [a,b] = things[i];
  return {
    question: `If all ${a} are ${b} and all ${b} are animals, are all ${a} animals? (yes/no)`,
    answer: "yes",
    latex: false,
    hint: "Transitivity.",
    type: "logic"
  };
}
/*--- Hard ---*/
function genAlgebraHard() {
  // Quadratic: ax^2+bx+c=0
  let a = randInt(1,3), b = randInt(2,6), x = randInt(2,7);
  let c = a*x*x + b*x;
  return {
    question: `Solve for x: \\(${a}x^2 + ${b}x = ${c}\\). Give the **positive** solution.`,
    answer: x,
    latex: true,
    hint: "Quadratic equation.",
    type: "algebra"
  };
}
function genSequenceHard() {
  // Prime sequence
  let start = randInt(3,13), primes = [], num = start, n=5;
  while(primes.length < n) {
    if (isPrime(num)) primes.push(num);
    num++;
  }
  return {
    question: `Next prime? ${primes.join(", ")}, ?`,
    answer: getNextPrime(primes[n-1]),
    latex: false,
    hint: "Next prime after last.",
    type: "sequence"
  };
}
function genNumberTheoryHard() {
  // Smallest integer >N divisible by K
  let n = randInt(100, 500), k = randInt(11, 37);
  let ans = n + (k - (n%k));
  if (ans === n) ans += k;
  return {
    question: `Smallest integer >${n} divisible by ${k}`,
    answer: ans,
    latex: false,
    hint: "Divide n by k, round up, multiply back.",
    type: "number-theory"
  };
}
function genLogicHard() {
  // "Yesterday's tomorrow is Thursday, what day is today?" Thursday
  let days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  let idx = randInt(0,6);
  let today = days[idx];
  return {
    question: `If yesterday's tomorrow is ${today}, what day is today?`,
    answer: today,
    latex: false,
    hint: "Yesterday's tomorrow is today!",
    type: "logic"
  };
}
function genGeometryHard() {
  // Area of circle, triangle, or rectangle
  let shape = randInt(0,2);
  if (shape === 0) {
    let r = randInt(3,15);
    return {
      question: `Area of a circle with r=${r} (to 2 decimals)`,
      answer: (a) => Math.abs(parseFloat(a) - Math.PI*r*r) < 0.02,
      latex: false,
      hint: "πr²",
      type: "geometry"
    };
  } else if (shape === 1) {
    let b = randInt(5,21), h = randInt(5,21);
    return {
      question: `Area of triangle with base=${b}, height=${h}`,
      answer: 0.5*b*h,
      latex: false,
      hint: "½bh",
      type: "geometry"
    };
  } else {
    let l = randInt(4,17), w = randInt(3,16);
    return {
      question: `Area of rectangle: ${l}x${w}`,
      answer: l*w,
      latex: false,
      hint: "l × w",
      type: "geometry"
    };
  }
}
/*--- Integral Bee ---*/
function genIntegrationBeePuzzle() {
  // Pick from BEE_PUZZLES
  let idx = randInt(0, BEE_PUZZLES.length-1);
  return BEE_PUZZLES[idx];
}
function genSeriesBeePuzzle() {
  // Basel, alternating, telescoping
  let ch = randInt(1,3);
  if (ch === 1) {
    return {
      question: "\\(\\sum_{n=1}^{\\infty} \\frac{1}{n(n+1)}\\)",
      answer: (a) => Math.abs(parseFloat(a) - 1) < 0.02,
      latex: true,
      hint: "Telescoping, sum = 1.",
      type: "bee"
    };
  } else if (ch === 2) {
    return {
      question: "\\(\\sum_{n=1}^{\\infty} \\frac{(-1)^{n+1}}{n}\\)",
      answer: (a) => Math.abs(parseFloat(a) - Math.log(2)) < 0.02,
      latex: true,
      hint: "Alternating harmonic, equals ln(2).",
      type: "bee"
    };
  } else {
    return {
      question: "\\(\\sum_{n=1}^{\\infty} \\frac{1}{n^2}\\)",
      answer: (a) => Math.abs(parseFloat(a) - Math.PI*Math.PI/6) < 0.02,
      latex: true,
      hint: "Basel Problem.",
      type: "bee"
    };
  }
}
function genLimitBeePuzzle() {
  let ch = randInt(1,2);
  if (ch===1) {
    return {
      question: "\\(\\lim_{x\\to 0} \\frac{e^x - 1 - x}{x^2}\\)",
      answer: (a) => Math.abs(parseFloat(a) - 0.5) < 0.02,
      latex: true,
      hint: "Use Taylor for e^x.",
      type: "bee"
    };
  } else {
    return {
      question: "\\(\\lim_{n \\to \\infty} \\left(1+\\frac{1}{n}\\right)^n\\)",
      answer: (a) => Math.abs(parseFloat(a) - Math.E) < 0.02,
      latex: true,
      hint: "It's Euler's number.",
      type: "bee"
    };
  }
}
/* ========== UTILITY FUNCTIONS ========== */
function randInt(a,b) {
  return Math.floor(Math.random()*(b-a+1))+a;
}
function gcd(a,b) {
  while (b !== 0) { let t = b; b = a%b; a = t; }
  return a;
}
function isPrime(n) {
  if (n < 2) return false;
  for (let i=2; i*i<=n; i++) if (n%i===0) return false;
  return true;
}
function getNextPrime(n) {
  let x = n+1;
  while (!isPrime(x)) x++;
  return x;
}
function shuffle(arr) {
  for (let i=arr.length-1; i>0; i--) {
    let j = randInt(0,i);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
/* ========== GAME LOGIC ========== */
function getPuzzle(difficulty) {
  // 20% chance: hand-written, 80%: generator
  if (PUZZLES[difficulty].length && Math.random() < 0.2) {
    return PUZZLES[difficulty][randInt(0,PUZZLES[difficulty].length-1)];
  }
  let gens = PUZZLE_GENERATORS[difficulty];
  return gens[randInt(0, gens.length-1)]();
}
function showPuzzle() {
  // Generate puzzle
  let diff = GAME.difficulty;
  if (GAME.beeMode || GAME.difficulty === "bee") diff = "bee";
  let puzzle = getPuzzle(diff);
  GAME.puzzle = puzzle;
  GAME.puzzleIndex++;
  GAME.puzzleHistory.push({puzzle, time: Date.now()});
  // Render
  UI.puzzleBox.innerHTML = puzzle.latex
    ? `<span class="math">${puzzle.question}</span>`
    : puzzle.question;
  // MathJax render
  if (puzzle.latex) MathJax.typesetPromise([UI.puzzleBox]);
  UI.answerInput.value = "";
  UI.resultBox.textContent = "";
  UI.resultBox.className = "result-message";
  UI.puzzleBox.classList.remove("lit");
  UI.answerInput.focus();
}
function updateUI() {
  UI.scoreBox.textContent = `Score: ${GAME.score}`;
  UI.levelBox.textContent = `Level ${GAME.level}`;
  UI.streakBox.textContent = `Streak: ${GAME.streak}`;
  UI.progressInner.style.width = `${Math.min(100, (GAME.puzzleIndex/GAME.maxLevel)*100)}%`;
  // Timer
  let t = GAME.timer;
  let m = String(Math.floor(t/60)).padStart(2,"0"), s = String(t%60).padStart(2,"0");
  UI.timerBox.textContent = `${m}:${s}`;
  if (t <= 10) UI.timerBox.classList.add("warning");
  else UI.timerBox.classList.remove("warning");
  // Achievements
  UI.achievementsBox.innerHTML = "";
  for (let badge of GAME.achievements) {
    let el = document.createElement("span");
    el.className = "achievement-badge";
    el.innerHTML = badge;
    UI.achievementsBox.appendChild(el);
  }
}
function playSound(type) {
  if (!GAME.sound) return;
  let el = document.getElementById(type==="correct"?"sfx-correct":
    type==="wrong"?"sfx-wrong": type==="hint"?"sfx-hint": "sfx-next");
  if (el) { el.currentTime = 0; el.play(); }
}
function checkAnswer(ans) {
  let puzzle = GAME.puzzle;
  if (!puzzle) return false;
  let answer = puzzle.answer;
  // Accept both numbers and strings (case-insensitive)
  if (typeof answer === "function") {
    try { return answer(ans); } catch { return false; }
  }
  if (typeof answer === "number") {
    if (typeof ans === "string") ans = ans.replace(/,/g,".");
    let num = parseFloat(ans);
    if (isNaN(num)) return false;
    // Accept rounding for hard/bee
    if (GAME.difficulty==="hard" || GAME.difficulty==="bee" || GAME.beeMode) {
      return Math.abs(num - answer) < 0.02;
    }
    return num === answer;
  }
  // Accept string or yes/no
  if (typeof answer === "string") {
    return ans.trim().toLowerCase() === answer.trim().toLowerCase();
  }
  return false;
}
function giveHint() {
  if (!GAME.puzzle || !GAME.puzzle.hint) return;
  UI.resultBox.textContent = "Hint: " + GAME.puzzle.hint;
  UI.resultBox.className = "result-message";
  playSound("hint");
  GAME.hintUsed++;
  unlockAchievement("Used a hint!");
}
function nextPuzzle(correct) {
  if (correct) {
    // Progress
    if (GAME.streak === 2) unlockAchievement("3 in a row!");
    if (GAME.streak === 9) unlockAchievement("10-streak!");
    if (GAME.difficulty==="bee" && GAME.streak === 4) unlockAchievement("Bee streak!");
    if (GAME.difficulty==="bee") {
      GAME.beeCorrect++;
      if (GAME.beeCorrect === 5) unlockAchievement("Bee Champion!");
    }
    GAME.score++;
    GAME.streak++;
    GAME.streakMax = Math.max(GAME.streakMax, GAME.streak);
    GAME.level = Math.max(GAME.level, Math.floor(GAME.score/2)+1);
    playSound("correct");
    UI.puzzleBox.classList.add("lit");
    UI.resultBox.textContent = "✅ Correct!";
    UI.resultBox.className = "result-message correct";
  } else {
    playSound("wrong");
    GAME.streak = 0;
    UI.resultBox.textContent = "❌ Wrong! Try again or skip.";
    UI.resultBox.className = "result-message wrong";
    unlockAchievement("Got one wrong!");
  }
  updateUI();
  if (correct) {
    setTimeout(() => {
      showPuzzle();
      updateUI();
      playSound("next");
    }, 750);
  }
}
/* ========== EVENT HANDLERS ========== */
UI.answerForm.onsubmit = function(e) {
  e.preventDefault();
  let ans = UI.answerInput.value.trim();
  if (!ans) return;
  let correct = checkAnswer(ans);
  nextPuzzle(correct);
  if (correct) {
    unlockAchievement("First correct!");
  }
};
UI.skipBtn.onclick = function() {
  GAME.skipCount++;
  unlockAchievement("Skipped a puzzle!");
  showPuzzle();
  updateUI();
};
UI.hintBtn.onclick = function() {
  giveHint();
};
UI.settingsOpenBtn.onclick = function() {
  UI.settingsPanel.classList.add("open");
};
UI.settingsCloseBtn.onclick = function() {
  UI.settingsPanel.classList.remove("open");
};
UI.toggleSoundSwitch.onclick = function() {
  GAME.sound = !GAME.sound;
  UI.toggleSoundSwitch.setAttribute("data-state", GAME.sound?"on":"off");
};
UI.toggleThemeSwitch.onclick = function() {
  if (GAME.theme === "cyberpunk") {
    // Light theme
    document.body.style.background = "linear-gradient(135deg,#e0eafc 0%, #c2c2d6 100%)";
    UI.themeLabel.textContent = "Light";
    GAME.theme = "light";
  } else {
    document.body.style.background = "";
    UI.themeLabel.textContent = "Cyberpunk";
    GAME.theme = "cyberpunk";
  }
};
UI.difficultySelect.onchange = function() {
  GAME.difficulty = UI.difficultySelect.value;
  if (GAME.difficulty === "bee") GAME.beeMode = true;
  else GAME.beeMode = false;
  GAME.level = 1; GAME.score = 0; GAME.streak = 0; GAME.puzzleIndex = 0;
  unlockAchievement(`Changed to ${GAME.difficulty} mode!`);
  showPuzzle();
  updateUI();
};
UI.typingModeSwitch.onclick = function() {
  GAME.typingMode = !GAME.typingMode;
  UI.typingModeSwitch.setAttribute("data-state", GAME.typingMode?"on":"off");
};
UI.resetGameBtn.onclick = function() {
  if (!confirm("Are you sure you want to reset all progress?")) return;
  GAME.level = 1;
  GAME.score = 0;
  GAME.streak = 0;
  GAME.puzzleIndex = 0;
  GAME.achievements = new Set();
  GAME.beeCorrect = 0;
  GAME.beeTotal = 0;
  GAME.skipCount = 0;
  GAME.hintUsed = 0;
  showPuzzle();
  updateUI();
};
/* ========== ACHIEVEMENTS ========== */
function unlockAchievement(text) {
  if (GAME.achievements.has(text)) return;
  GAME.achievements.add(text);
  updateUI();
  // Animate badge
  let badge = Array.from(UI.achievementsBox.children).find(el => el.textContent === text);
  if (badge) {
    badge.animate([
      { transform: "scale(1)" },
      { transform: "scale(1.25)", filter:"brightness(2)" },
      { transform: "scale(1)" }
    ], { duration: 800 });
  }
}
/* ========== TIMER LOGIC ========== */
function startTimer() {
  if (GAME.timerInterval) clearInterval(GAME.timerInterval);
  GAME.timer = 0;
  GAME.timerStart = Date.now();
  GAME.timerInterval = setInterval(() => {
    GAME.timer = Math.floor((Date.now()-GAME.timerStart)/1000);
    updateUI();
    if (GAME.timer > 599) unlockAchievement("Played for 10min!");
    if (GAME.timer > 30 && GAME.difficulty==="bee") unlockAchievement("Bee survivor!");
  }, 1000);
}
startTimer();
/* ========== CYBERPUNK BACKGROUND ANIMATION ========== */
function drawBackgroundGrid() {
  let svg = document.querySelector(".cyber-bg-anim svg");
  let gridLines = svg.querySelector("#grid-lines");
  let floating = svg.querySelector("#floating-neon");
  let w = window.innerWidth, h = window.innerHeight;
  gridLines.innerHTML = "";
  for (let x=0; x<w; x+=80) {
    let col = x%160===0 ? "var(--neon-blue)" : "#1a2444";
    let line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1",x); line.setAttribute("y1",0);
    line.setAttribute("x2",x); line.setAttribute("y2",h);
    line.setAttribute("stroke",col);
    line.setAttribute("stroke-width", x%160===0 ? 2.5 : 1);
    line.setAttribute("opacity",x%160===0?"0.18":"0.08");
    gridLines.appendChild(line);
  }
  for (let y=0; y<h; y+=70) {
    let col = y%140===0 ? "var(--neon-pink)" : "#1a2444";
    let line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1",0); line.setAttribute("y1",y);
    line.setAttribute("x2",w); line.setAttribute("y2",y);
    line.setAttribute("stroke",col);
    line.setAttribute("stroke-width", y%140===0 ? 2.5 : 1);
    line.setAttribute("opacity",y%140===0?"0.19":"0.08");
    gridLines.appendChild(line);
  }
  // Neon floating shapes
  floating.innerHTML = "";
  for (let i=0;i<4;i++) {
    let circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    let cx = randInt(70,w-70), cy = randInt(60,h-60), r = randInt(22,60);
    let col = [ "var(--neon-pink)", "var(--neon-blue)", "var(--neon-yellow)", "var(--neon-green)" ][i%4];
    circle.setAttribute("cx",cx); circle.setAttribute("cy",cy); circle.setAttribute("r",r);
    circle.setAttribute("fill",col);
    circle.setAttribute("opacity","0.07");
    floating.appendChild(circle);
  }
}
window.addEventListener("resize",drawBackgroundGrid);
drawBackgroundGrid();
/* ========== KEYBOARD SHORTCUTS ========== */
document.addEventListener("keydown", function(e) {
  if (UI.settingsPanel.classList.contains("open")) return;
  if (GAME.typingMode && e.ctrlKey && e.key === "l") {
    // Insert LaTeX lambda
    insertAtCursor(UI.answerInput, "\\lambda");
    e.preventDefault();
  }
  if (e.key === "Enter" && document.activeElement !== UI.answerInput) {
    UI.answerInput.focus();
  }
  if (e.key === "Escape") {
    UI.answerInput.blur();
  }
});
function insertAtCursor(input, text) {
  let start = input.selectionStart, end = input.selectionEnd;
  input.value = input.value.slice(0,start) + text + input.value.slice(end);
  input.selectionStart = input.selectionEnd = start + text.length;
}
/* ========== INITIALIZE GAME ========== */
showPuzzle();
updateUI();
<script src="someaddons.js"></script>
</body>
</html>
